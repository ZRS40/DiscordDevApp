<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Details</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1 id="guild-name"></h1>
    <div class="details-container">
        <div class="column">
            <div class="column-header">
                <h2>Roles</h2>
                <button id="create-role-btn" class="icon-btn" title="Create Role">+</button>
            </div>
            <ul id="roles-list"></ul>
        </div>
        <div class="column">
            <h2>Channels</h2>
            <ul id="channels-list"></ul>
        </div>
    </div>

    <script>
        const guildNameElement = document.getElementById('guild-name');
        const rolesList = document.getElementById('roles-list');
        const channelsList = document.getElementById('channels-list');

        const urlParams = new URLSearchParams(window.location.search);
        const guildId = urlParams.get('id');

        if (guildId) {
            fetch(`/api/guilds/${guildId}`)
                .then(response => response.json())
                .then(data => {
                    guildNameElement.textContent = data.name;

                    data.roles.forEach(role => {
                        const listItem = document.createElement('li');
                        listItem.dataset.roleId = role.id;
                        listItem.draggable = true;

                        const roleNameSpan = document.createElement('span');
                        roleNameSpan.textContent = role.name;
                        listItem.appendChild(roleNameSpan);

                        const controlsDiv = document.createElement('div');

                        const editBtn = document.createElement('button');
                        editBtn.textContent = '✏️';
                        editBtn.className = 'icon-btn edit-role-btn';
                        editBtn.dataset.roleId = role.id;
                        editBtn.dataset.roleName = role.name;
                        editBtn.dataset.roleColor = role.color;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '🗑️';
                        deleteBtn.className = 'icon-btn delete-role-btn';
                        deleteBtn.dataset.roleId = role.id; // Store role ID

                        controlsDiv.appendChild(editBtn);
                        controlsDiv.appendChild(deleteBtn);
                        listItem.appendChild(controlsDiv);
                        rolesList.appendChild(listItem);
                    });

                    // Add event listeners after the loop
                    document.getElementById('create-role-btn').addEventListener('click', handleCreateRole);
                    document.querySelectorAll('.delete-role-btn').forEach(btn => {
                        btn.addEventListener('click', handleDeleteRole);
                    });
                    document.querySelectorAll('.edit-role-btn').forEach(btn => {
                        btn.addEventListener('click', handleOpenEditModal);
                    });

                    // Clear the list first
                    channelsList.innerHTML = '';

                    data.channels.forEach(category => {
                        const categoryHeader = document.createElement('h3');
                        categoryHeader.className = 'category-header';
                        categoryHeader.textContent = category.name.toUpperCase();
                        channelsList.appendChild(categoryHeader);

                        const channelSubList = document.createElement('ul');
                        category.channels.forEach(channel => {
                            const listItem = document.createElement('li');
                            // Add a prefix based on channel type
                            let prefix = '# '; // Default for text
                            if (channel.type === 2 /* GuildVoice */) {
                                prefix = '🔊 ';
                            } else if (channel.type === 13 /* GuildStageVoice */) {
                                prefix = '🎤 ';
                            } else if (channel.type === 15 /* GuildForum */) {
                                prefix = '📰 ';
                            }
                            listItem.textContent = prefix + channel.name;
                            channelSubList.appendChild(listItem);
                        });
                        channelsList.appendChild(channelSubList);
                    });
                })
                .catch(error => console.error('Error fetching guild details:', error));
        }

        async function handleCreateRole() {
            const roleName = prompt('Enter the name for the new role:');
            if (!roleName) return;

            try {
                const response = await fetch(`/api/guilds/${guildId}/roles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: roleName })
                });
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error creating role: ${error.details || error.error}`);
                }
            } catch (err) {
                alert(`An error occurred: ${err.message}`);
            }
        }

        async function handleDeleteRole(event) {
            const roleId = event.target.dataset.roleId;
            if (!confirm('Are you sure you want to delete this role?')) return;

            try {
                const response = await fetch(`/api/guilds/${guildId}/roles/${roleId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error deleting role: ${error.details || error.error}`);
                }
            } catch (err) {
                alert(`An error occurred: ${err.message}`);
            }
        }

        // --- Edit Role Modal Logic ---
        const modal = document.getElementById('edit-role-modal');
        const editForm = document.getElementById('edit-role-form');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const roleIdInput = document.getElementById('edit-role-id');
        const roleNameInput = document.getElementById('edit-role-name');
        const roleColorInput = document.getElementById('edit-role-color');

        function handleOpenEditModal(event) {
            const btn = event.currentTarget;
            roleIdInput.value = btn.dataset.roleId;
            roleNameInput.value = btn.dataset.roleName;
            roleColorInput.value = btn.dataset.roleColor;
            modal.style.display = 'flex';
        }

        function handleCloseEditModal() {
            modal.style.display = 'none';
        }

        async function handleUpdateRole(event) {
            event.preventDefault();
            const roleId = roleIdInput.value;
            const roleName = roleNameInput.value;
            const roleColor = roleColorInput.value;

            try {
                const response = await fetch(`/api/guilds/${guildId}/roles/${roleId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: roleName, color: roleColor })
                });

                if (response.ok) {
                    handleCloseEditModal();
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error updating role: ${error.details || error.error}`);
                }
            } catch (err) {
                alert(`An error occurred: ${err.message}`);
            }
        }

        // Add modal event listeners
        editForm.addEventListener('submit', handleUpdateRole);
        cancelBtn.addEventListener('click', handleCloseEditModal);


        // --- Drag and Drop Role Reordering ---
        const rolesListEl = document.getElementById('roles-list');
        let draggedItem = null;

        rolesListEl.addEventListener('dragstart', e => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });

        rolesListEl.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(rolesListEl, e.clientY);
            if (afterElement == null) {
                rolesListEl.appendChild(draggedItem);
            } else {
                rolesListEl.insertBefore(draggedItem, afterElement);
            }
        });

        rolesListEl.addEventListener('dragend', async e => {
            e.target.classList.remove('dragging');

            const newRolePositions = [];
            const roleElements = rolesListEl.querySelectorAll('li');
            const totalRoles = roleElements.length;

            roleElements.forEach((li, index) => {
                newRolePositions.push({ role: li.dataset.roleId, position: totalRoles - 1 - index });
            });

            try {
                const response = await fetch(`/api/guilds/${guildId}/roles`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newRolePositions)
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error reordering roles: ${error.details || error.error}`);
                    location.reload(); // Reload to reset to original state
                }
            } catch (err) {
                alert(`An error occurred: ${err.message}`);
                location.reload();
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>

    <div id="edit-role-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h2>Edit Role</h2>
            <form id="edit-role-form">
                <input type="hidden" id="edit-role-id">
                <label for="edit-role-name">Role Name:</label>
                <input type="text" id="edit-role-name" required>
                <label for="edit-role-color">Role Color:</label>
                <input type="color" id="edit-role-color">
                <div class="modal-actions">
                    <button type="submit">Save</button>
                    <button type="button" id="cancel-edit-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
